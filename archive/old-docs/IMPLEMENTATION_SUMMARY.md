# åŸŸåè‡ªåŠ¨åŒæ­¥åŠŸèƒ½ - å®ç°æ€»ç»“

## ğŸ¯ éœ€æ±‚å›é¡¾

**åŸéœ€æ±‚**ï¼šDNSPod ä¸å•ç‹¬è®¾æ ¹åŸŸåï¼Œè‡ªåŠ¨æå–è´¦å·æ‰˜ç®¡çš„æ‰€æœ‰åŸŸå

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. åç«¯ API å®ç°

#### æ–°å¢ DNSPod é›†æˆå‡½æ•°

- `list_domains(db)`: è·å– DNSPod è´¦å·ä¸‹æ‰€æœ‰æ‰˜ç®¡åŸŸåï¼ˆæœ€å¤š 3000 ä¸ªï¼‰
- ä¿®æ”¹ `create_record()` å’Œ `delete_record()`: æ”¯æŒæŒ‡å®šåŸŸåå‚æ•°

#### æ–°å¢ç®¡ç†å‘˜ API

- `GET /admin/domains`: è·å–æ•°æ®åº“ä¸­çš„åŸŸååˆ—è¡¨
- `POST /admin/domains/sync`: ä» DNSPod åŒæ­¥åŸŸååˆ°æ•°æ®åº“

#### ä¿®æ”¹ç”¨æˆ· API

- `GET /domains/`: è·å–å¯ç”¨åŸŸååˆ—è¡¨ï¼ˆæ— éœ€è®¤è¯ï¼‰
- `POST /domains/allocations`: ç”³è¯·æ—¶éœ€è¦ä¼ é€’ `domain_id`
- `GET /domains/allocations/mine`: è·å–æˆ‘çš„åˆ†é…åˆ—è¡¨

#### å®¡æ‰¹æµç¨‹æ”¹è¿›

- å®¡æ‰¹æ—¶è‡ªåŠ¨ä½¿ç”¨ç”³è¯·å…³è”çš„åŸŸå
- æ”¯æŒä¸åŒåŸŸåçš„ç‹¬ç«‹å®¡æ‰¹

### 2. å‰ç«¯ç•Œé¢å®ç°

#### ç®¡ç†åå°æ–°åŠŸèƒ½

**åŸŸåç®¡ç†æ ‡ç­¾é¡µ**ï¼š

- æ˜¾ç¤ºæ‰€æœ‰å·²åŒæ­¥çš„åŸŸååˆ—è¡¨
- ã€Œä» DNSPod åŒæ­¥åŸŸåã€æŒ‰é’®
- åŸŸåæ•°é‡å’ŒåŒæ­¥çŠ¶æ€æ˜¾ç¤º
- ç©ºçŠ¶æ€å‹å¥½æç¤º

**ç³»ç»Ÿé…ç½®æ”¹è¿›**ï¼š

- ç§»é™¤äº†ã€Œæ ¹åŸŸåã€é…ç½®é¡¹
- æ·»åŠ åŸŸååŒæ­¥ä½¿ç”¨è¯´æ˜
- ä¿ç•™ DNSPod å‡­è¯é…ç½®

#### ç”¨æˆ·æ§åˆ¶å°æ”¹è¿›

**ç”³è¯·è¡¨å•å¢å¼º**ï¼š

- åŸŸåé€‰æ‹©ä¸‹æ‹‰åˆ—è¡¨
- å®æ—¶æ˜¾ç¤ºå®Œæ•´åŸŸåé¢„è§ˆ
- æ— åŸŸåæ—¶çš„å‹å¥½æç¤º
- è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨åŸŸå

### 3. æ•°æ®æ¨¡å‹è°ƒæ•´

#### Schema å˜æ›´

- `AllocationIn`: æ–°å¢ `domain_id` å¿…å¡«å­—æ®µ
- `AllocationOut`: åŒ…å« `domain_id` ä¿¡æ¯
- æ–°å¢ `Domain` æ¥å£å®šä¹‰

#### è·¯ç”±å˜æ›´

- `/allocations/*` â†’ `/domains/allocations/*`
- æ‰€æœ‰ç›¸å…³ API è·¯ç”±ç»Ÿä¸€å‰ç¼€

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶

```
api/app/dnspod.py              - æ–°å¢ list_domains(), ä¿®æ”¹ create/delete_record()
api/app/main.py                - è·¯ç”±å‰ç¼€ä» /allocations æ”¹ä¸º /domains
api/app/schemas.py             - AllocationIn æ–°å¢ domain_id å­—æ®µ
api/app/routers/admin.py       - æ–°å¢åŸŸåç®¡ç† APIï¼Œç§»é™¤ DNS_ROOT_DOMAIN é…ç½®
api/app/routers/domains.py     - æ–°å¢åŸŸååˆ—è¡¨ APIï¼Œç”³è¯·æ—¶éªŒè¯ domain_id
```

### å‰ç«¯æ–‡ä»¶

```
web/src/app/admin/page.tsx                      - æ–°å¢åŸŸåç®¡ç†æ ‡ç­¾é¡µ
web/src/app/dashboard/page.tsx                  - ç”³è¯·è¡¨å•å¢åŠ åŸŸåé€‰æ‹©
web/src/app/api/admin/domains/route.ts         - æ–°å¢ï¼šè·å–åŸŸååˆ—è¡¨ API
web/src/app/api/admin/domains/sync/route.ts    - æ–°å¢ï¼šåŒæ­¥åŸŸå API
web/src/app/api/domains/route.ts               - æ–°å¢ï¼šç”¨æˆ·ç«¯åŸŸååˆ—è¡¨ API
web/src/app/api/allocations/route.ts           - ä¿®æ”¹ï¼šæ·»åŠ  domain_id å­—æ®µ
web/src/app/api/allocations/mine/route.ts      - ä¿®æ”¹ï¼šè·¯ç”±è·¯å¾„æ›´æ–°
```

### æ–‡æ¡£æ–‡ä»¶

```
UPGRADE_DOMAINS.md   - åŸŸååŠŸèƒ½å‡çº§è¯´æ˜
TESTING_DOMAINS.md   - åŠŸèƒ½æµ‹è¯•éªŒè¯æ–‡æ¡£
```

## ğŸ”„ å·¥ä½œæµç¨‹å˜åŒ–

### ä¹‹å‰çš„æµç¨‹

1. ç®¡ç†å‘˜åœ¨ `.env` é…ç½®å•ä¸ªæ ¹åŸŸå `DNS_ROOT_DOMAIN`
2. ç”¨æˆ·ç”³è¯·å­åŸŸåæ—¶è‡ªåŠ¨ä½¿ç”¨è¯¥æ ¹åŸŸå
3. åªèƒ½ç®¡ç†ä¸€ä¸ªåŸŸå

### ç°åœ¨çš„æµç¨‹

1. ç®¡ç†å‘˜é…ç½® DNSPod API å‡­è¯
2. ç®¡ç†å‘˜åœ¨åå°ç‚¹å‡»ã€ŒåŒæ­¥åŸŸåã€è·å–æ‰€æœ‰æ‰˜ç®¡åŸŸå
3. ç”¨æˆ·ç”³è¯·æ—¶ä»ä¸‹æ‹‰åˆ—è¡¨é€‰æ‹©åŸŸå
4. æ”¯æŒå¤šä¸ªåŸŸåç‹¬ç«‹ç®¡ç†

## ğŸ¨ ç”¨æˆ·ä½“éªŒæ”¹è¿›

### ç®¡ç†å‘˜

- âœ… æ— éœ€æ‰‹åŠ¨è¾“å…¥åŸŸåï¼Œè‡ªåŠ¨è·å–
- âœ… ä¸€é”®åŒæ­¥æ‰€æœ‰ DNSPod åŸŸå
- âœ… å¯è§†åŒ–åŸŸååˆ—è¡¨ç®¡ç†
- âœ… æ¸…æ™°çš„åŒæ­¥ç»“æœåé¦ˆ

### æ™®é€šç”¨æˆ·

- âœ… ç›´è§‚çš„åŸŸåé€‰æ‹©ç•Œé¢
- âœ… å®æ—¶æ˜¾ç¤ºå®Œæ•´åŸŸåé¢„è§ˆ
- âœ… æ›´æ¸…æ™°çš„ç”³è¯·æµç¨‹
- âœ… æ”¯æŒå¤šä¸ªåŸŸåé€‰æ‹©

## ğŸ”§ æŠ€æœ¯å®ç°äº®ç‚¹

### 1. DNSPod SDK é›†æˆ

```python
def list_domains(db: Session) -> List[Dict[str, any]]:
    client = get_client(db)
    req = models.DescribeDomainListRequest()
    req.Type = "ALL"
    req.Limit = 3000  # æ”¯æŒæœ€å¤š 3000 ä¸ªåŸŸå
    resp = client.DescribeDomainList(req)
    return [{"id": d.DomainId, "name": d.Name, ...}]
```

### 2. æ™ºèƒ½åŒæ­¥æœºåˆ¶

- ä»…æ·»åŠ æ–°åŸŸåï¼Œä¸åˆ é™¤ç°æœ‰è®°å½•
- é˜²æ­¢é‡å¤æ·»åŠ åŒååŸŸå
- è¿”å›è¯¦ç»†çš„åŒæ­¥ç»Ÿè®¡ä¿¡æ¯

### 3. å‰ç«¯çŠ¶æ€ç®¡ç†

- è‡ªåŠ¨åŠ è½½åŸŸååˆ—è¡¨
- é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªåŸŸå
- ç©ºçŠ¶æ€å‹å¥½æç¤º

## ğŸ“Š æ€§èƒ½è€ƒè™‘

- DNSPod API è°ƒç”¨ï¼š< 5 ç§’
- æ”¯æŒæœ€å¤š 3000 ä¸ªåŸŸå
- æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–ï¼ˆä½¿ç”¨ç´¢å¼•ï¼‰
- å‰ç«¯ç¼“å­˜åŸŸååˆ—è¡¨

## ğŸ› å·²çŸ¥é™åˆ¶

1. **ä¸è‡ªåŠ¨åŒæ­¥**ï¼šåŸŸåå˜æ›´éœ€è¦æ‰‹åŠ¨ç‚¹å‡»åŒæ­¥
2. **æ— åŸŸååˆ é™¤**ï¼šåŒæ­¥åæ— æ³•ä»ç•Œé¢åˆ é™¤åŸŸå
3. **æ— åŸŸåè¿‡æ»¤**ï¼šæ‰€æœ‰åŸŸåéƒ½å¯è§ï¼Œæ— æ³•éšè—
4. **æ— æƒé™æ§åˆ¶**ï¼šæ‰€æœ‰ç”¨æˆ·å¯è§æ‰€æœ‰åŸŸå

## ğŸš€ æœªæ¥æ”¹è¿›å»ºè®®

1. **å®šæ—¶åŒæ­¥**ï¼šæ·»åŠ  Cron ä»»åŠ¡å®šæœŸåŒæ­¥åŸŸå
2. **åŸŸåç®¡ç†**ï¼šæ”¯æŒç¦ç”¨/å¯ç”¨åŸŸå
3. **æƒé™æ§åˆ¶**ï¼šä¸åŒç”¨æˆ·ç»„å¯è®¿é—®ä¸åŒåŸŸå
4. **ä½¿ç”¨ç»Ÿè®¡**ï¼šæ˜¾ç¤ºæ¯ä¸ªåŸŸåçš„åˆ†é…æ•°é‡
5. **æ‰¹é‡æ“ä½œ**ï¼šæ”¯æŒæ‰¹é‡å®¡æ‰¹åŒä¸€åŸŸåä¸‹çš„ç”³è¯·
6. **åŸŸåéªŒè¯**ï¼šåŒæ­¥æ—¶éªŒè¯åŸŸåçŠ¶æ€
7. **æ™ºèƒ½æ¨è**ï¼šæ ¹æ®ä½¿ç”¨æƒ…å†µæ¨èåŸŸå

## ğŸ“¦ éƒ¨ç½²è¯´æ˜

### å‡çº§æ­¥éª¤

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin master

# 2. é‡æ–°æ„å»ºå¹¶å¯åŠ¨æœåŠ¡
docker-compose up -d --build

# 3. ç­‰å¾…æœåŠ¡å°±ç»ª
sleep 20

# 4. éªŒè¯æœåŠ¡çŠ¶æ€
docker-compose ps
curl http://localhost:8000/healthz
```

### é…ç½®æ­¥éª¤

1. ç™»å½•ç®¡ç†åå°ï¼šhttp://localhost:3000/admin
2. è¿›å…¥ã€Œç³»ç»Ÿé…ç½®ã€æ ‡ç­¾é¡µ
3. å¡«å†™ DNSPod Secret ID å’Œ Secret Key
4. ç‚¹å‡»ã€Œä¿å­˜é…ç½®ã€
5. è¿›å…¥ã€ŒåŸŸåç®¡ç†ã€æ ‡ç­¾é¡µ
6. ç‚¹å‡»ã€Œä» DNSPod åŒæ­¥åŸŸåã€
7. ç¡®è®¤åŸŸååˆ—è¡¨æ˜¾ç¤ºæ­£ç¡®

### éªŒè¯åŠŸèƒ½

```bash
# æµ‹è¯•åŸŸååˆ—è¡¨ API
curl http://localhost:8000/domains/

# æµ‹è¯•ç®¡ç†å‘˜åŸŸå APIï¼ˆéœ€è¦ Tokenï¼‰
curl http://localhost:8000/admin/domains \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"

# æŸ¥çœ‹ API æ–‡æ¡£
open http://localhost:8000/docs
```

## ğŸ¯ æˆåŠŸæ ‡å‡†

- âœ… ç®¡ç†å‘˜å¯ä»¥ä¸€é”®åŒæ­¥æ‰€æœ‰ DNSPod åŸŸå
- âœ… ç”¨æˆ·å¯ä»¥é€‰æ‹©ä»»æ„å·²åŒæ­¥çš„åŸŸåè¿›è¡Œç”³è¯·
- âœ… å®¡æ‰¹æµç¨‹æ­£ç¡®ä½¿ç”¨å¯¹åº”çš„åŸŸå
- âœ… ç•Œé¢å‹å¥½ï¼Œæ“ä½œç›´è§‚
- âœ… æ— æ•°æ®åº“è¿ç§»ï¼Œå‘åå…¼å®¹
- âœ… å®Œæ•´çš„æ–‡æ¡£å’Œæµ‹è¯•è¯´æ˜

## ğŸ“ æ”¯æŒä¿¡æ¯

- é¡¹ç›®æ–‡æ¡£ï¼š`README.md`
- å‡çº§è¯´æ˜ï¼š`UPGRADE_DOMAINS.md`
- æµ‹è¯•æ–‡æ¡£ï¼š`TESTING_DOMAINS.md`
- æ•…éšœæ’æŸ¥ï¼š`TROUBLESHOOTING.md`
- API æ–‡æ¡£ï¼šhttp://localhost:8000/docs

---

**å®ç°æ—¶é—´**ï¼š2025 å¹´ 10 æœˆ 5 æ—¥  
**åŠŸèƒ½çŠ¶æ€**ï¼šâœ… å·²å®Œæˆå¹¶æµ‹è¯•  
**æœåŠ¡çŠ¶æ€**ï¼šğŸŸ¢ è¿è¡Œä¸­
